import{a7 as ge,F as he,a8 as xe,a9 as ne,n as ae,o as re,aa as fe,j as e,u as ie,b as _e,k as ve}from"./index-327d1c16.js";import{V as je,a as Ne}from"./index.esm-2e521957.js";import{u as le}from"./useMutation-c7ebb76c.js";import{R as oe,T as be}from"./TextFilter-c32df3ae.js";import{f as ye}from"./index-37c4a7e4.js";import{F as Ce,p as Le}from"./Fab-f562133d.js";import{u as Ie}from"./useRemainingViewPortHeight-741cb570.js";function Re(n){const i=n.providers,r=Object.keys(i),t={};for(let s=0;s<r.length;s++){const m=r[s];t[m]={...i[m],idx:s}}return{byName:t,names:r}}async function ke(n){const i=await ge(n)||{providers:{}};return Re(i)}async function ce({name:n,apiConfig:i}){const{url:r,init:t}=he(i);try{return(await fetch(r+`/providers/rules/${n}`,{method:"PUT",...t})).ok}catch(s){return console.log("failed to PUT /providers/rules/:name",s),!1}}async function we({names:n,apiConfig:i}){for(let r=0;r<n.length;r++)await ce({name:n[r],apiConfig:i})}const $=xe("");function ze(n,i){const r=re(),{mutate:t,isLoading:s}=le(ce,{onSuccess:()=>{r.invalidateQueries(["/providers/rules"])}});return[p=>{p.preventDefault(),t({name:n,apiConfig:i})},s]}function Pe(n){const i=re(),{data:r}=de(n),{mutate:t,isLoading:s}=le(we,{onSuccess:()=>{i.invalidateQueries(["/providers/rules"])}});return[p=>{p.preventDefault(),t({names:r.names,apiConfig:n})},s]}function de(n){return ne(["/providers/rules",n],ke)}function Te(n){const{data:i,isFetching:r}=ne(["/rules",n],fe),{data:t}=de(n),[s]=ae($);if(s==="")return{rules:i,provider:t,isFetching:r};{const m=s.toLowerCase();return{rules:i.filter(p=>p.payload.toLowerCase().indexOf(m)>=0),isFetching:r,provider:{byName:t.byName,names:t.names.filter(p=>p.toLowerCase().indexOf(m)>=0)}}}}const Se="_RuleProviderItem_1y502_1",He="_providerCard_1y502_15",Me="_providerIcon_1y502_21",Ae="_avatar_1y502_25",Be="_providerInfo_1y502_38",De="_providerHeader_1y502_43",Ee="_providerStats_1y502_50",We="_providerActions_1y502_57",Fe="_btn_1y502_61",I={RuleProviderItem:Se,providerCard:He,providerIcon:Me,avatar:Ae,providerInfo:Be,providerHeader:De,providerStats:Ee,"text-muted":"_text-muted_1y502_53",providerActions:We,btn:Fe,"btn-primary":"_btn-primary_1y502_65","d-flex":"_d-flex_1y502_92"};function $e({idx:n,name:i,vehicleType:r,behavior:t,updatedAt:s,ruleCount:m,apiConfig:p}){const[b,o]=ze(i,p),j=ye(new Date(s),new Date);return e.jsx("div",{className:I.RuleProviderItem,children:e.jsxs("div",{className:I.providerCard,children:[e.jsxs("div",{className:I.providerIcon,children:[e.jsx("span",{className:"avatar bg-primary text-white",children:e.jsx("i",{className:"ti ti-database"})}),e.jsxs("span",{className:"badge badge-outline text-muted position-absolute",style:{top:"-8px",right:"-8px",fontSize:"0.7rem"},children:["#",n]})]}),e.jsxs("div",{className:I.providerInfo,children:[e.jsxs("div",{className:I.providerHeader,children:[e.jsxs("h4",{className:"mb-1 fw-bold text-truncate",title:i,children:[e.jsx("i",{className:"ti ti-shield-check me-2 text-success"}),i]}),e.jsxs("div",{className:"d-flex align-items-center gap-2 mb-2",children:[e.jsxs("span",{className:"badge badge-outline text-info",children:[e.jsx("i",{className:"ti ti-truck me-1"}),r]}),e.jsxs("span",{className:"badge badge-outline text-warning",children:[e.jsx("i",{className:"ti ti-settings me-1"}),t]})]})]}),e.jsx("div",{className:I.providerStats,children:e.jsxs("div",{className:"d-flex align-items-center gap-3 text-muted",children:[e.jsxs("div",{className:"d-flex align-items-center gap-1",children:[e.jsx("i",{className:"ti ti-list"}),e.jsx("span",{className:"fw-medium",children:m}),e.jsx("span",{children:m===1?"rule":"rules"})]}),e.jsxs("div",{className:"d-flex align-items-center gap-1",children:[e.jsx("i",{className:"ti ti-clock"}),e.jsxs("span",{children:["Updated ",j," ago"]})]})]})})]}),e.jsx("div",{className:I.providerActions,children:e.jsxs("div",{className:"d-flex flex-column gap-2",children:[e.jsxs("button",{className:"btn btn-primary btn-sm d-flex align-items-center gap-2",onClick:b,disabled:o,children:[e.jsx(oe,{isRotating:o,size:14}),e.jsx("span",{children:"Update"})]}),e.jsxs("div",{className:"dropdown",children:[e.jsx("button",{className:"btn btn-ghost-secondary btn-sm","data-bs-toggle":"dropdown","aria-expanded":"false",children:e.jsx("i",{className:"ti ti-dots-vertical"})}),e.jsxs("div",{className:"dropdown-menu dropdown-menu-end",children:[e.jsxs("button",{className:"dropdown-item",children:[e.jsx("i",{className:"ti ti-info-circle me-2"}),"Provider Details"]}),e.jsxs("button",{className:"dropdown-item",children:[e.jsx("i",{className:"ti ti-download me-2"}),"Download Rules"]}),e.jsx("div",{className:"dropdown-divider"}),e.jsxs("button",{className:"dropdown-item text-danger",children:[e.jsx("i",{className:"ti ti-trash me-2"}),"Remove Provider"]})]})]})]})})]})})}function Ue({apiConfig:n}){const[i,r]=Pe(n),{t}=ie();return e.jsx(Ce,{icon:e.jsx(oe,{isRotating:r}),text:t("update_all_rule_provider"),style:Le,onClick:i})}const Qe="_rule_1fdj1_1",qe="_ruleCard_1fdj1_13",Oe="_ruleId_1fdj1_20",Ke="_ruleContent_1fdj1_27",Ve="_payload_1fdj1_35",Ye="_ruleDetails_1fdj1_51",Ze="_ruleActions_1fdj1_58",R={rule:Qe,ruleCard:qe,ruleId:Oe,ruleContent:Ke,payload:Ve,ruleDetails:Ye,ruleActions:Ze},ee={DIRECT:{color:"success",icon:"arrow-right"},REJECT:{color:"danger",icon:"x"},_default:{color:"info",icon:"world"}};function Je({proxy:n}){return ee[n]||ee._default}function Xe({type:n,payload:i,proxy:r,id:t}){const s=Je({proxy:r});return e.jsx("div",{className:R.rule,children:e.jsxs("div",{className:R.ruleCard,children:[e.jsx("div",{className:R.ruleId,children:e.jsxs("span",{className:"badge badge-outline text-muted",children:["#",t]})}),e.jsxs("div",{className:R.ruleContent,children:[e.jsxs("div",{className:R.payload,children:[e.jsx("i",{className:"ti ti-code me-2 text-muted"}),e.jsx("code",{className:"text-primary",children:i})]}),e.jsx("div",{className:R.ruleDetails,children:e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsxs("span",{className:"badge badge-outline text-secondary",children:[e.jsx("i",{className:"ti ti-filter me-1"}),n]}),e.jsxs("span",{className:`badge badge-outline text-${s.color}`,children:[e.jsx("i",{className:`ti ti-${s.icon} me-1`}),r]})]})})]}),e.jsx("div",{className:R.ruleActions,children:e.jsxs("div",{className:"dropdown",children:[e.jsx("button",{className:"btn btn-ghost-secondary btn-sm","data-bs-toggle":"dropdown","aria-expanded":"false",children:e.jsx("i",{className:"ti ti-dots-vertical"})}),e.jsxs("div",{className:"dropdown-menu dropdown-menu-end",children:[e.jsxs("button",{className:"dropdown-item",children:[e.jsx("i",{className:"ti ti-copy me-2"}),"Copy Rule"]}),e.jsxs("button",{className:"dropdown-item",children:[e.jsx("i",{className:"ti ti-info-circle me-2"}),"Rule Details"]})]})]})})]})})}const Ge="_header_uk6z7_2",es="_RuleProviderItemWrapper_uk6z7_18",ss="_scrollIndicator_uk6z7_25",ts="_scrollProgress_uk6z7_36",ns="_scrollProgressBar_uk6z7_42",as="_loadTriggerHint_uk6z7_49",rs="_pulse_uk6z7_1",is="_bounce_uk6z7_1",ls="_loading_uk6z7_67",os="_loadingPulse_uk6z7_1",cs="_spin_uk6z7_1",ds="_virtualListWrapper_uk6z7_109",us="_virtualListContainer_uk6z7_115",ms="_pageHeader_uk6z7_135",ps="_statsContainer_uk6z7_148",gs="_rulesCard_uk6z7_153",hs="_streamingContainer_uk6z7_173",xs="_fadeInUp_uk6z7_1",fs="_loadingProgress_uk6z7_177",_s="_progressBar_uk6z7_181",vs="_progressFill_uk6z7_186",js="_complete_uk6z7_208",Ns="_scrollLoadingIndicator_uk6z7_212",bs="_fadeIn_uk6z7_1",ys="_loadingText_uk6z7_217",Cs="_loadMoreButton_uk6z7_222",Ls="_adaptiveLoading_uk6z7_240",Is="_shimmer_uk6z7_1",v={header:Ge,RuleProviderItemWrapper:es,scrollIndicator:ss,scrollProgress:ts,scrollProgressBar:ns,loadTriggerHint:as,pulse:rs,bounce:is,loading:ls,loadingPulse:os,spin:cs,virtualListWrapper:ds,virtualListContainer:us,pageHeader:ms,"page-pretitle":"_page-pretitle_uk6z7_135","page-title":"_page-title_uk6z7_142",statsContainer:ps,"fw-medium":"_fw-medium_uk6z7_148",rulesCard:gs,"card-header":"_card-header_uk6z7_153","card-title":"_card-title_uk6z7_157","card-actions":"_card-actions_uk6z7_162","card-body":"_card-body_uk6z7_166",streamingContainer:hs,fadeInUp:xs,loadingProgress:fs,progressBar:_s,progressFill:vs,complete:js,scrollLoadingIndicator:Ns,fadeIn:bs,loadingText:ys,loadMoreButton:Cs,adaptiveLoading:Ls,shimmer:Is},{memo:Rs,useState:P,useEffect:T,useMemo:W,startTransition:se,useCallback:C,useRef:F}=ve,te=30;function ks(n,{rules:i,provider:r}){var p;const t=((p=r==null?void 0:r.names)==null?void 0:p.length)||0;if(n<t)return r.names[n];const s=n-t,m=i[s];return(m==null?void 0:m.id)||`rule-${s}`}function ws({provider:n}){return function(r){var s;const t=((s=n==null?void 0:n.names)==null?void 0:s.length)||0;return r<t?130:90}}const ue=Rs(({index:n,style:i,data:r})=>{var j;const{rules:t,provider:s,apiConfig:m}=r,p=((j=s==null?void 0:s.names)==null?void 0:j.length)||0;if(n<p){const U=s.names[n],k=s.byName[U];return e.jsx("div",{style:i,className:v.RuleProviderItemWrapper,children:e.jsx($e,{apiConfig:m,...k,idx:n+1})})}const b=n-p,o=t[b];return o?e.jsx("div",{style:i,children:e.jsx(Xe,{...o,id:n+1})}):e.jsx("div",{style:i,className:"d-flex align-items-center justify-content-center",children:e.jsx("div",{className:"spinner-border spinner-border-sm text-muted",role:"status",style:{width:"16px",height:"16px"},children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})})})},Ne);ue.displayName="MemoRow";function Es(){var V,Y,Z,J,X,G;const n=_e(),[i,r]=Ie(),{rules:t,provider:s}=Te(n),[m,p]=ae($),{t:b}=ie(),[o,j]=P(0),[U,k]=P(!0),[h,Q]=P(!1),[zs,q]=P(0),[Ps,S]=P(!1),w=F(),O=F(null),d=W(()=>{var a;return((t==null?void 0:t.length)||0)+(((a=s==null?void 0:s.names)==null?void 0:a.length)||0)},[t==null?void 0:t.length,(V=s==null?void 0:s.names)==null?void 0:V.length]),K=C(()=>{var f;if(r<=0)return 20;const a=((f=s==null?void 0:s.names)==null?void 0:f.length)||0,l=(t==null?void 0:t.length)||0,c=a>0&&l>0?(a*130+l*90)/(a+l):110,u=Math.ceil(r/c),g=Math.ceil(u*.5);return Math.min(u+g,d)},[r,(Y=s==null?void 0:s.names)==null?void 0:Y.length,t==null?void 0:t.length,d]);T(()=>{if(d===0){k(!1),j(0);return}j(0),k(!0);const a=K(),l=10;let c=0;const u=()=>{if(c>=a){k(!1);return}const g=a-c,f=Math.min(c===0?Math.ceil(a*.4):15,g),_=c+f;se(()=>{j(_)}),c=_,c<a?setTimeout(u,l):setTimeout(()=>k(!1),l)};setTimeout(u,20)},[d,K]);const N=C(()=>{h||o>=d||(Q(!0),w.current&&clearTimeout(w.current),w.current=setTimeout(()=>{const l=Math.min(o+30,d);se(()=>{j(l),Q(!1)})},20))},[h,o,d]),z=F(null),y=C(()=>{z.current&&clearTimeout(z.current),z.current=setTimeout(()=>{!h&&o<d&&N()},10)},[h,o,d,N]),me=C(({scrollDirection:a,scrollOffset:l,scrollUpdateWasRequested:c})=>{var u,g;if(a==="forward"&&!c){const f=((g=(u=O.current)==null?void 0:u.props)==null?void 0:g.height)||r,_=d*100,x=Math.min(l/(_-f),1);q(Math.round(x*100));const E=x>.5&&o<d;S(E),x>.9&&o<d&&!h?N():x>.6&&o<d&&!h&&y()}},[r,d,o,h,y]),H=C(a=>{const l=a.target;if(!l)return;const c=l.closest('[data-testid="virtual-list"]');if(c){const u=c.querySelector(`.${v.virtualListContainer}`);if(u){const{scrollTop:g,scrollHeight:f,clientHeight:_}=u,x=Math.min(g/(f-_),1);q(Math.round(x*100));const E=x>.5&&o<d;S(E),x>.9&&!h&&o<d?N():x>.5&&!h&&o<d&&y()}}},[h,o,d,y,N]),M=C(a=>{if(a.deltaY>0&&!h&&o<d){const c=a.target.closest('[data-testid="virtual-list"]');if(c){const u=c.querySelector(`.${v.virtualListContainer}`);if(u){const{scrollTop:g,scrollHeight:f,clientHeight:_}=u,x=g/(f-_);x>.85?N():x>.4&&y()}}}},[h,o,d,y]),A=C(a=>{if(h||o>=d)return;const c=a.target.closest('[data-testid="virtual-list"]');if(c){const u=c.querySelector(`.${v.virtualListContainer}`);if(u){const{scrollTop:g,scrollHeight:f,clientHeight:_}=u,x=g/(f-_);x>.85?N():x>.55&&y()}}},[h,o,d,y]);T(()=>()=>{w.current&&clearTimeout(w.current),z.current&&clearTimeout(z.current),p("")},[p]);const L=W(()=>{var l;if(!t||!s)return{rules:[],provider:{names:[],byName:{}}};const a=((l=s==null?void 0:s.names)==null?void 0:l.length)||0;if(o<=a)return{rules:[],provider:{names:s.names.slice(0,o),byName:s.byName}};{const c=Math.min(o-a,t.length);return{rules:t.slice(0,c),provider:s}}},[t,s,o]),B=W(()=>{var c,u,g;const a=((u=(c=L.provider)==null?void 0:c.names)==null?void 0:u.length)||0,l=((g=L.rules)==null?void 0:g.length)||0;return a+l},[(J=(Z=L.provider)==null?void 0:Z.names)==null?void 0:J.length,(X=L.rules)==null?void 0:X.length]),D=C(a=>{const l=a.target;if(l.closest(`.${v.virtualListContainer}`)){const c=l.closest(`.${v.virtualListContainer}`),{clientWidth:u,scrollWidth:g}=c;if(g>u){const f=c.getBoundingClientRect();a.clientX>f.right-20&&S(!0)}}},[]);if(T(()=>{const a=i.current;if(a)return a.addEventListener("scroll",H,{passive:!0}),a.addEventListener("wheel",M,{passive:!0}),a.addEventListener("touchmove",A,{passive:!0}),a.addEventListener("mousedown",D,{passive:!0}),()=>{a.removeEventListener("scroll",H),a.removeEventListener("wheel",M),a.removeEventListener("touchmove",A),a.removeEventListener("mousedown",D)}},[H,M,A,D]),T(()=>{const a=l=>{(l.ctrlKey||l.metaKey)&&l.key==="l"&&!h&&B<d&&(l.preventDefault(),N())};return document.addEventListener("keydown",a),()=>{document.removeEventListener("keydown",a)}},[N,h,B,d]),!t||!s)return e.jsx("div",{className:"page-wrapper",children:e.jsx("div",{className:"page-body",children:e.jsx("div",{className:"container-xl",children:e.jsx("div",{className:"card tabler-card",children:e.jsx("div",{className:"card-body text-center py-5",children:e.jsxs("div",{className:"empty",children:[e.jsx("div",{className:"empty-icon",children:e.jsx("div",{className:"spinner-border text-primary",role:"status",style:{width:"32px",height:"32px"},children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})})}),e.jsx("p",{className:"empty-title",children:"Loading rules..."})]})})})})})});const pe=ws({provider:L.provider});return e.jsxs("div",{className:"page-wrapper",children:[e.jsx("div",{className:"page-header d-print-none",children:e.jsx("div",{className:"container-fluid px-4",children:e.jsxs("div",{className:"row g-2 align-items-center",children:[e.jsxs("div",{className:"col",children:[e.jsx("div",{className:"page-pretitle",children:"Configuration"}),e.jsxs("h2",{className:"page-title d-flex align-items-center gap-2",children:[e.jsx("i",{className:"ti ti-list-details"}),b("Rules")]})]}),e.jsx("div",{className:"col-auto",children:e.jsxs("div",{className:"d-flex gap-2 flex-wrap",children:[e.jsxs("div",{className:`d-flex align-items-center gap-3 text-muted ${v.statsContainer}`,children:[e.jsxs("div",{className:"d-flex align-items-center gap-1",children:[e.jsx("i",{className:"ti ti-database"}),e.jsx("span",{className:"fw-medium",children:((G=s==null?void 0:s.names)==null?void 0:G.length)||0}),e.jsx("span",{className:"text-muted d-none d-sm-inline",children:"Providers"}),m&&e.jsxs("span",{className:"badge badge-outline badge-sm text-info",children:[e.jsx("i",{className:"ti ti-filter me-1"}),e.jsx("span",{className:"d-none d-md-inline",children:"Filtered"})]})]}),e.jsxs("div",{className:"d-flex align-items-center gap-1",children:[e.jsx("i",{className:"ti ti-list"}),e.jsx("span",{className:"fw-medium",children:(t==null?void 0:t.length)||0}),e.jsx("span",{className:"text-muted d-none d-sm-inline",children:"Rules"}),m&&e.jsxs("span",{className:"badge badge-outline badge-sm text-info",children:[e.jsx("i",{className:"ti ti-filter me-1"}),e.jsx("span",{className:"d-none d-md-inline",children:"Filtered"})]})]})]}),e.jsx("div",{style:{minWidth:"200px",maxWidth:"300px",flex:"1 1 auto"},children:e.jsx(be,{placeholder:b("Search rules..."),textAtom:$})})]})})]})})}),e.jsx("div",{className:"page-body",children:e.jsx("div",{className:"container-fluid px-4",children:e.jsxs("div",{className:`card tabler-card ${v.rulesCard}`,children:[e.jsxs("div",{className:"card-header",children:[e.jsxs("h3",{className:"card-title d-flex align-items-center gap-2",children:[e.jsx("i",{className:"ti ti-shield-check"}),b("Rules & Providers")]}),e.jsx("div",{className:"card-actions",children:e.jsx("div",{className:"text-muted d-flex align-items-center gap-2",children:e.jsxs("span",{children:[d," ",b("items"),m&&e.jsxs("span",{className:"badge badge-outline badge-sm text-info ms-2",children:[e.jsx("i",{className:"ti ti-filter me-1"}),e.jsx("span",{className:"d-none d-sm-inline",children:"Filtered Results"})]})]})})})]}),e.jsx("div",{className:"card-body p-0",children:e.jsx("div",{ref:i,style:{paddingBottom:te},className:v.streamingContainer,children:e.jsx("div",{"data-testid":"virtual-list",className:v.virtualListWrapper,children:e.jsx(je,{ref:O,height:r-te,width:"100%",itemCount:B,itemSize:pe,itemData:{rules:L.rules,provider:L.provider,apiConfig:n},itemKey:ks,className:v.virtualListContainer,onScroll:me,overscanCount:5,children:ue})})})})]})})}),s!=null&&s.names&&s.names.length>0?e.jsx(Ue,{apiConfig:n}):null]})}export{Es as default};
